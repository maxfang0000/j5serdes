# project-agnostic makefile which monitors *.in files in source directory

include config.mk

SRC_DIR  := $(CFG_SRC_DIR)
IN_FILES := $(shell find $(SRC_DIR) -type f -name \*.in)
SRC_IN_FILES := $(shell cd $(SRC_DIR) && find . -type f -name \*.in)
POPULATED_IN_FILES := $(patsubst %.in,%,$(SRC_IN_FILES))

MAKEFLAGS := --no-print-directory

.PHONY: default all regenerate clean

.SILENT:

all: default

default: regenerate
	@$(MAKE) -f main.mk

clean: regenerate
	@$(MAKE) -f main.mk clean

run: regenerate
	@$(MAKE) -f main.mk run

regenerate: .update_mk

.update_mk: $(POPULATED_IN_FILES)
	@touch .update_mk
	@echo "... cleaning up old artifacts"
	@$(MAKE) -f main.mk clean

%.mk: $(SRC_DIR)/%.mk.in
	@echo "... regenerating $@"
	@cp $< $@

Makefile: $(SRC_DIR)/Makefile.in
	@echo "... regenerating $@"
	@cp $< $@

%:
	@$(MAKE) -f main.mk $@
